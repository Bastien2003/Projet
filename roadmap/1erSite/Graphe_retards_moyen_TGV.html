<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Retard moyen des TGV par gare</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
        }
        #container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }
        canvas {
            max-width: 100%;
        }
        .note {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #555;
        }
    </style>
</head>
<body>
<div id="container">
    <h1>Retard moyen des TGV par gare</h1>
    <p>Graphique basé sur les gares TVG de Nîmes, Montpellier, Perpignan et Toulouse Matabiau (retard moyen au départ et à l'arrivée).</p>

    <canvas id="retardsChart" height="120"></canvas>

    <p class="note">
        Observation: On remarque que en moyenne les retards au départ est d'environ 3 minute par gare,
                     cependant à l'arrivée le temps de retard varie d'un trajet à l'autre mais reste toujours supérieur à celui du départ.
    </p>
</div>

<script>
// Liste des fichiers CSV à charger (un fichier = une gare)
const csvFiles = [
    "nimes_retard_arrivee+depart_tgv.csv",
    "montpellier_retard_arrivee+depart_tgv.csv",
    "perpignan_retard_arrivee+depart_tgv.csv",
    "toulouse_matabiau_retard_arrivee+depart_tgv.csv"
];

// Noms exacts des colonnes dans les CSV
const COL_GARE = "Gare de départ";
const COL_RETARD_DEP = "Retard moyen de tous les trains au départ";
const COL_RETARD_ARR = "Retard moyen de tous les trains à l'arrivée";

// Fonction principale : reproduit le comportement de graphe_retards_tgv.py
async function main() {
    const labels = [];         // Nom des gares
    const moyennesDep = [];    // Retard moyen au départ
    const moyennesArr = [];    // Retard moyen à l'arrivée

    for (const file of csvFiles) {
        try {
            const text = await fetchCsv(file);
            const rows = parseCsv(text, ";");
            if (rows.length === 0) continue;

            // gare = première ligne de la colonne "Gare de départ",
            // comme dans df["Gare de départ"].iloc[0]
            const gare = rows[0][COL_GARE] || file;

            const valsDep = [];
            const valsArr = [];

            // On parcourt toutes les lignes du fichier (comme df[col].mean())
            rows.forEach(row => {
                const depStr = row[COL_RETARD_DEP];
                const arrStr = row[COL_RETARD_ARR];

                if (depStr !== undefined && depStr !== "") {
                    const vDep = parseFloat(depStr.replace(",", "."));
                    if (!isNaN(vDep)) valsDep.push(vDep);
                }

                if (arrStr !== undefined && arrStr !== "") {
                    const vArr = parseFloat(arrStr.replace(",", "."));
                    if (!isNaN(vArr)) valsArr.push(vArr);
                }
            });

            // Si on a des données, on calcule la moyenne
            if (valsDep.length > 0 || valsArr.length > 0) {
                labels.push(gare);
                moyennesDep.push(moyenne(valsDep));
                moyennesArr.push(moyenne(valsArr));
            }
        } catch (e) {
            console.error("Erreur lors du chargement de", file, e);
        }
    }

    dessinerGraphe(labels, moyennesDep, moyennesArr);
}

// Charge le contenu d'un CSV (texte brut)
async function fetchCsv(path) {
    const response = await fetch(path);
    if (!response.ok) {
        throw new Error("HTTP " + response.status);
    }
    return await response.text();
}

// Parseur CSV très simple (séparateur = sep)
function parseCsv(text, sep) {
    const lines = text.trim().split(/\r?\n/);
    if (lines.length < 2) return [];

    const headers = lines[0].split(sep).map(h => h.trim());
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const cols = lines[i].split(sep);
        const obj = {};
        headers.forEach((h, idx) => {
            obj[h] = (cols[idx] || "").trim();
        });
        rows.push(obj);
    }
    return rows;
}

// Calcul de la moyenne
function moyenne(arr) {
    if (!arr || arr.length === 0) return 0;
    const sum = arr.reduce((a, b) => a + b, 0);
    return sum / arr.length;
}

// Dessin du graphique avec Chart.js
function dessinerGraphe(labels, dataDep, dataArr) {
    const ctx = document.getElementById("retardsChart").getContext("2d");

    new Chart(ctx, {
        type: "bar",
        data: {
            labels: labels,
            datasets: [
                {
                    label: "Retard moyen au départ (min)",
                    data: dataDep
                },
                {
                    label: "Retard moyen à l'arrivée (min)",
                    data: dataArr
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: "Minutes"
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: "Gare"
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            const v = context.parsed.y;
                            return context.dataset.label + ": " + v.toFixed(2) + " min";
                        }
                    }
                },
                legend: {
                    position: "top"
                },
                title: {
                    display: false
                }
            }
        }
    });
}

// On lance tout
main();
</script>
</body>
</html>